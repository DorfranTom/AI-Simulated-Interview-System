<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI模拟面试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#0FC6C2',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-shadow {
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(22, 93, 255, 0.1);
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</head>
<body class="font-inter bg-neutral min-h-screen flex flex-col">
<header class="bg-primary text-white shadow-md">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold flex items-center">
      <i class="fa fa-comments-o mr-2"></i>AI模拟面试系统
    </h1>
    <nav>
      <ul class="flex space-x-6">
        <li><a href="#" class="hover:text-secondary transition-colors"><i class="fa fa-home mr-1"></i>首页</a></li>
        <li><a href="#" class="hover:text-secondary transition-colors"><i class="fa fa-history mr-1"></i>历史记录</a></li>
        <li><a href="#" class="hover:text-secondary transition-colors"><i class="fa fa-cog mr-1"></i>设置</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="flex-1 container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
  <!-- 左侧面试列表 -->
  <aside class="w-full md:w-1/4 bg-white rounded-lg shadow-md p-4 sidebar-shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-dark">面试列表</h2>
      <button id="newInterviewBtn" class="bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors flex items-center">
        <i class="fa fa-plus mr-1"></i>新建
      </button>
    </div>
    <div id="interviewList" class="space-y-3">
      <div class="text-center text-gray-500 py-8">
        <i class="fa fa-spinner fa-spin text-primary text-2xl mb-2"></i>
        <p>正在加载面试数据...</p>
      </div>
    </div>
  </aside>

  <!-- 右侧面试内容区域 -->
  <section class="w-full md:w-3/4 bg-white rounded-lg shadow-md p-6">
    <div id="interviewContent" class="min-h-[500px]">
      <div class="text-center py-16">
        <img src="https://picsum.photos/200/150" alt="AI面试" class="mx-auto rounded-lg mb-4 opacity-70">
        <h3 class="text-xl font-semibold text-gray-700 mb-2">选择一个面试开始</h3>
        <p class="text-gray-500 max-w-md mx-auto">从左侧列表中选择一个面试会话，或创建一个新的面试开始模拟</p>
      </div>
    </div>
  </section>
</main>

<footer class="bg-dark text-white py-6">
  <div class="container mx-auto px-4 text-center">
    <p>© 2025 AI模拟面试系统 - 帮助你提升面试技巧</p>
    <div class="mt-4 flex justify-center space-x-4">
      <a href="#" class="hover:text-primary transition-colors"><i class="fa fa-github"></i></a>
      <a href="#" class="hover:text-primary transition-colors"><i class="fa fa-twitter"></i></a>
      <a href="#" class="hover:text-primary transition-colors"><i class="fa fa-linkedin"></i></a>
    </div>
  </div>
</footer>

<!-- 自动保存通知组件 -->
<div id="autoSaveNotification" class="fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg bg-green-500 text-white opacity-0 transition-opacity duration-300 flex items-center">
  <i class="fa fa-check-circle mr-2"></i>
  <span>已自动保存</span>
</div>

<script>
  // 页面加载时获取所有面试信息
  document.addEventListener('DOMContentLoaded', () => {
    loadInterviews();

    // 新建面试按钮事件
    document.getElementById('newInterviewBtn').addEventListener('click', createNewInterview);
  });

  // 页面关闭时尝试保存当前面试
  window.addEventListener('beforeunload', () => {
    if (currentInterview) {
      saveCurrentInterview(true); // true表示是关闭页面时的保存
    }
  });

  // 自动保存相关变量
  let currentInterview = null;
  let saveTimer = null;
  const AUTO_SAVE_INTERVAL = 30000; // 30秒

  // 加载所有面试信息
  function loadInterviews() {
    fetch('/api/interviews')
            .then(response => response.json())
            .then(interviews => {
              const interviewList = document.getElementById('interviewList');
              interviewList.innerHTML = '';

              if (interviews.length === 0) {
                interviewList.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <i class="fa fa-folder-open-o text-primary text-3xl mb-3"></i>
                                <p>暂无面试记录</p>
                                <button id="createFirstInterview" class="mt-3 bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 transition-colors">
                                    创建第一个面试
                                </button>
                            </div>
                        `;
                document.getElementById('createFirstInterview').addEventListener('click', createNewInterview);
              } else {
                interviews.forEach(interview => {
                  const interviewCard = document.createElement('div');
                  interviewCard.className = 'bg-white border border-gray-200 rounded-lg p-3 card-hover cursor-pointer';
                  interviewCard.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold text-dark">${interview.interviewTitle || '未命名面试'}</h3>
                                        <p class="text-sm text-gray-500 mt-1">
                                            <i class="fa fa-user-o mr-1"></i>${interview.candidateName || '未知候选人'}
                                        </p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            <i class="fa fa-clock-o mr-1"></i>${new Date(interview.startTime).toLocaleString()}
                                        </p>
                                    </div>
                                    <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">
                                        ${interview.positionType || '未知岗位'}
                                    </span>
                                </div>
                            `;

                  interviewCard.addEventListener('click', () => {
                    loadInterviewDetails(interview.sessionId);
                  });

                  interviewCard.dataset.sessionId = interview.sessionId;
                  interviewList.appendChild(interviewCard);
                });
              }
            })
            .catch(error => {
              console.error('获取面试列表失败:', error);
              document.getElementById('interviewList').innerHTML = `
                        <div class="text-center text-red-500 py-8">
                            <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>加载面试数据失败，请刷新页面重试</p>
                        </div>
                    `;
            });
  }

  // 创建新面试
  function createNewInterview() {
    const candidateName = prompt('请输入候选人姓名:');
    if (!candidateName) return;

    const positionType = prompt('请输入应聘岗位:');
    if (!positionType) return;

    const interviewTitle = prompt('请输入面试标题:', `${positionType} - ${candidateName}`);

    const newInterview = {
      candidateName,
      positionType,
      interviewTitle,
      startTime: new Date().toISOString()
    };

    fetch('/api/interviews', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newInterview)
    })
            .then(response => response.json())
            .then(createdInterview => {
              loadInterviews();
              loadInterviewDetails(createdInterview.sessionId);
              startAutoSave(createdInterview.sessionId);
              showNotification('面试创建成功！');
            })
            .catch(error => {
              console.error('创建面试失败:', error);
              showNotification('面试创建失败，请重试', true);
            });
  }

  // 加载面试详情
  function loadInterviewDetails(sessionId) {
    document.getElementById('interviewContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fa fa-spinner fa-spin text-primary text-2xl mb-2"></i>
                    <p>加载面试详情中...</p>
                </div>
            `;

    // 实际项目中应通过API获取面试详情
    fetch(`/api/interviews/${sessionId}`)
            .then(response => response.json())
            .then(interview => {
              renderInterviewDetails(interview);
              startAutoSave(sessionId);
            })
            .catch(error => {
              console.error('加载面试详情失败:', error);
              document.getElementById('interviewContent').innerHTML = `
                        <div class="text-center text-red-500 py-16">
                            <i class="fa fa-exclamation-circle text-4xl mb-4"></i>
                            <h3 class="text-xl font-semibold">加载面试详情失败</h3>
                            <p>请检查网络连接或刷新页面重试</p>
                            <button id="retryBtn" class="mt-4 bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 transition-colors">
                                重试
                            </button>
                        </div>
                    `;
              document.getElementById('retryBtn').addEventListener('click', () => {
                loadInterviewDetails(sessionId);
              });
            });
  }

  // 渲染面试详情
  function renderInterviewDetails(interview) {
    const content = document.getElementById('interviewContent');
    content.innerHTML = `
                <div class="border-b border-gray-200 pb-4 mb-6">
                    <h2 class="text-2xl font-bold text-dark">${interview.interviewTitle || '未命名面试'}</h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">
                            <i class="fa fa-user-o mr-1"></i>${interview.candidateName || '未知候选人'}
                        </span>
                        <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">
                            <i class="fa fa-briefcase mr-1"></i>${interview.positionType || '未知岗位'}
                        </span>
                        <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">
                            <i class="fa fa-clock-o mr-1"></i>${new Date(interview.startTime).toLocaleString()}
                        </span>
                    </div>
                </div>

                <div class="bg-neutral rounded-lg p-5 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">面试问题与回答</h3>
                        <button id="addQuestionBtn" class="text-primary hover:text-primary/80 text-sm flex items-center">
                            <i class="fa fa-plus-circle mr-1"></i> 添加问题
                        </button>
                    </div>

                    <div id="qaContainer" class="space-y-6">
                        ${renderQAPairs(interview.questions || [], interview.answers || [])}
                    </div>
                </div>

                <div class="flex justify-between">
                    <button id="endInterviewBtn" class="bg-gray-500 text-white px-5 py-2 rounded hover:bg-gray-600 transition-colors">
                        结束面试
                    </button>
                    <button id="nextQuestionBtn" class="bg-primary text-white px-5 py-2 rounded hover:bg-primary/90 transition-colors">
                        下一个问题
                    </button>
                </div>
            `;

    // 添加事件监听器
    document.getElementById('addQuestionBtn').addEventListener('click', () => {
      addNewQuestion(sessionId);
    });

    document.getElementById('endInterviewBtn').addEventListener('click', () => {
      endInterview(sessionId);
    });

    document.getElementById('nextQuestionBtn').addEventListener('click', () => {
      generateNextQuestion(sessionId);
    });
  }

  // 渲染问题和回答对
  function renderQAPairs(questions, answers) {
    let html = '';

    questions.forEach(question => {
      const answer = answers.find(a => a.questionId === question.questionId);

      html += `
                    <div class="bg-white p-4 rounded-lg shadow-sm fade-in">
                        <div class="flex items-start mb-3">
                            <div class="bg-primary/10 text-primary rounded-full w-8 h-8 flex items-center justify-center mr-3 shrink-0">
                                <i class="fa fa-question"></i>
                            </div>
                            <div>
                                <p class="font-medium text-dark">${question.content}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    ${question.category ? `<i class="fa fa-folder-o mr-1"></i>${question.category} · ` : ''}
                                    ${question.difficulty ? `<i class="fa fa-signal mr-1"></i>${question.difficulty} · ` : ''}
                                    <i class="fa fa-clock-o mr-1"></i>${new Date(question.timestamp).toLocaleString()}
                                </p>
                            </div>
                        </div>

                        ${answer ? `
                            <div class="flex items-start ml-11 mt-3">
                                <div class="bg-secondary/10 text-secondary rounded-full w-8 h-8 flex items-center justify-center mr-3 shrink-0">
                                    <i class="fa fa-comment"></i>
                                </div>
                                <div>
                                    <p class="text-gray-700">${answer.content}</p>
                                    ${answer.evaluation ? `
                                        <div class="mt-3 p-2 bg-green-50 border border-green-100 rounded">
                                            <div class="flex items-center text-green-600 text-sm">
                                                <i class="fa fa-check-circle mr-1"></i>
                                                <span>评估得分: ${answer.evaluation.overallScore.toFixed(1)}/10</span>
                                            </div>
                                            ${answer.evaluation.feedback ? `
                                                <p class="text-xs text-gray-600 mt-1">${answer.evaluation.feedback}</p>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : `
                            <div class="flex items-start ml-11 mt-3">
                                <div class="bg-gray-100 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center mr-3 shrink-0">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <div>
                                    <p class="text-gray-500 italic">等待回答...</p>
                                </div>
                            </div>
                        `}
                    </div>
                `;
    });

    return html;
  }

  // 添加新问题
  function addNewQuestion(sessionId) {
    const question = prompt('请输入新问题:');
    if (!question) return;

    const category = prompt('请输入问题类别 (可选):');
    const difficulty = prompt('请输入问题难度 (简单/中等/困难):');

    const newQuestion = {
      content: question,
      category: category || null,
      difficulty: difficulty || null,
      timestamp: new Date().toISOString()
    };

    fetch(`/api/interviews/${sessionId}/questions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newQuestion)
    })
            .then(response => response.json())
            .then(updatedInterview => {
              renderInterviewDetails(updatedInterview);
              showNotification('问题已添加');
            })
            .catch(error => {
              console.error('添加问题失败:', error);
              showNotification('添加问题失败，请重试', true);
            });
  }

  // 生成下一个问题
  function generateNextQuestion(sessionId) {
    document.getElementById('qaContainer').insertAdjacentHTML('beforeend', `
                <div class="text-center py-8">
                    <i class="fa fa-spinner fa-spin text-primary text-2xl mb-2"></i>
                    <p>正在生成下一个问题...</p>
                </div>
            `);

    fetch(`/api/interviews/${sessionId}/generate-next-question`, {
      method: 'POST'
    })
            .then(response => response.json())
            .then(updatedInterview => {
              renderInterviewDetails(updatedInterview);
              showNotification('新问题已生成');
            })
            .catch(error => {
              console.error('生成问题失败:', error);
              document.getElementById('qaContainer').lastElementChild.remove();
              showNotification('生成问题失败，请重试', true);
            });
  }

  // 结束面试
  function endInterview(sessionId) {
    if (!confirm('确定要结束本次面试吗？结束后将生成面试报告。')) return;

    fetch(`/api/interviews/${sessionId}/complete`, {
      method: 'POST'
    })
            .then(response => response.json())
            .then(report => {
              // 显示面试报告
              document.getElementById('interviewContent').innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-block bg-green-100 text-green-600 rounded-full px-4 py-2 mb-4">
                            <i class="fa fa-check-circle mr-1"></i> 面试已完成
                        </div>
                        <h2 class="text-2xl font-bold text-dark mb-2">面试报告</h2>
                        <p class="text-gray-500 mb-6">${report.sessionId}</p>

                        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6 text-left">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-neutral rounded p-4 text-center">
                                    <p class="text-gray-500 text-sm">总体评分</p>
                                    <p class="text-3xl font-bold text-primary mt-1">${report.overallScore.toFixed(1)}/10</p>
                                </div>
                                <div class="bg-neutral rounded p-4 text-center">
                                    <p class="text-gray-500 text-sm">问题数量</p>
                                    <p class="text-3xl font-bold text-dark mt-1">${report.totalQuestions}</p>
                                </div>
                                <div class="bg-neutral rounded p-4 text-center">
                                    <p class="text-gray-500 text-sm">面试时长</p>
                                    <p class="text-3xl font-bold text-dark mt-1">${report.durationMinutes}分钟</p>
                                </div>
                            </div>

                            <h3 class="font-semibold text-lg mb-3">优势</h3>
                            <ul class="list-disc list-inside text-green-600 mb-4">
                                ${report.strengths.map(s => `<li>${s}</li>`).join('') || '<li>无明显优势</li>'}
                            </ul>

                            <h3 class="font-semibold text-lg mb-3">改进建议</h3>
                            <ul class="list-disc list-inside text-red-600 mb-4">
                                ${report.suggestions.map(s => `<li>${s}</li>`).join('') || '<li>无明显改进建议</li>'}
                            </ul>

                            <h3 class="font-semibold text-lg mb-3">知识差距</h3>
                            <ul class="list-disc list-inside text-yellow-600 mb-4">
                                ${report.knowledgeGaps.map(g => `<li>${g}</li>`).join('') || '<li>无明显知识差距</li>'}
                            </ul>

                            <div class="mt-6 text-center">
                                <button id="downloadReportBtn" class="bg-primary text-white px-5 py-2 rounded hover:bg-primary/90 transition-colors">
                                    <i class="fa fa-download mr-1"></i> 下载报告
                                </button>
                                <button id="newInterviewBtn" class="ml-2 bg-gray-200 text-gray-700 px-5 py-2 rounded hover:bg-gray-300 transition-colors">
                                    <i class="fa fa-plus mr-1"></i> 新面试
                                </button>
                            </div>
                        </div>
                    </div>
                `;

              // 添加事件监听器
              document.getElementById('downloadReportBtn').addEventListener('click', () => {
                downloadReport(report);
              });

              document.getElementById('newInterviewBtn').addEventListener('click', createNewInterview);

              // 停止自动保存
              stopAutoSave();

              // 刷新面试列表
              loadInterviews();
            })
            .catch(error => {
              console.error('结束面试失败:', error);
              showNotification('结束面试失败，请重试', true);
            });
  }

  // 下载报告
  function downloadReport(report) {
    // 实际项目中应该调用后端API生成PDF报告
    alert('报告下载功能将在实际项目中实现');
  }

  // 显示通知
  function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
    notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fa ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

    document.body.appendChild(notification);

    // 3秒后自动消失
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(20px)';
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  // 开始自动保存
  function startAutoSave(sessionId) {
    currentInterview = sessionId;

    // 清除之前的计时器
    if (saveTimer) {
      clearInterval(saveTimer);
    }

    // 设置新的计时器
    saveTimer = setInterval(() => {
      if (currentInterview) {
        saveCurrentInterview();
      }
    }, AUTO_SAVE_INTERVAL);

    console.log(`开始自动保存面试 ${sessionId}，每${AUTO_SAVE_INTERVAL/1000}秒一次`);
  }

  // 停止自动保存
  function stopAutoSave() {
    if (saveTimer) {
      clearInterval(saveTimer);
      saveTimer = null;
    }
    currentInterview = null;
    console.log('停止自动保存');
  }

  // 保存当前面试
  function saveCurrentInterview(isClosing = false) {
    if (!currentInterview) return;

    console.log(`保存面试 ${currentInterview} (${isClosing ? '关闭页面时' : '自动保存'})`);

    // 实际项目中应发送请求到后端保存
    fetch(`/api/interviews/${currentInterview}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        // 这里应该包含需要保存的数据
        // 例如：当前问题、回答、状态等
      })
    })
            .then(response => {
              if (response.ok) {
                if (!isClosing) {
                  showAutoSaveNotification();
                }
                console.log('面试已保存');
              } else {
                console.error('保存失败:', response.statusText);
              }
            })
            .catch(error => {
              console.error('保存面试失败:', error);
            });
  }

  // 显示自动保存通知
  function showAutoSaveNotification() {
    const notification = document.getElementById('autoSaveNotification');
    notification.style.opacity = '1';

    setTimeout(() => {
      notification.style.opacity = '0';
    }, 2000);
  }
</script>
</body>
</html>